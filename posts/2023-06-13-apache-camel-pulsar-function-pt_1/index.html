<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Apache Camel Pulsar Function, Part 1 | Luca Burgazzoli</title>
<meta property="og:title" content="Apache Camel Pulsar Function, Part 1 | Luca Burgazzoli"><meta name=twitter:title content="Apache Camel Pulsar Function, Part 1 | Luca Burgazzoli"><meta itemprop=name content="Apache Camel Pulsar Function, Part 1 | Luca Burgazzoli"><meta name=application-name content="Apache Camel Pulsar Function, Part 1 | Luca Burgazzoli"><meta property="og:site_name" content=".: LB :."><meta name=description content="        Yet another software developer.
        Ideas are my own.
        "><meta itemprop=description content="        Yet another software developer.
        Ideas are my own.
        "><meta property="og:description" content="        Yet another software developer.
        Ideas are my own.
        "><meta name=twitter:description content="        Yet another software developer.
        Ideas are my own.
        "><meta property="og:locale" content="en-us"><meta name=language content="en-us"><meta itemprop=image content="https://lburgazzoli.github.io"><meta property="og:image" content="https://lburgazzoli.github.io"><meta name=twitter:image content="https://lburgazzoli.github.io"><meta name=twitter:image:src content="https://lburgazzoli.github.io"><meta property="og:type" content="article"><meta property="og:article:published_time" content="2023-06-15T00:00:00Z"><meta property="article:published_time" content="2023-06-15T00:00:00Z"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Apache Camel Pulsar Function, Part 1","author":{"@type":"Person","name":""},"datePublished":"2023-06-15","description":"","wordCount":788,"mainEntityOfPage":"True","dateModified":"2023-06-15","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Luca Burgazzoli"}}</script><meta name=generator content="Hugo 0.122.0"><link rel=canonical href=https://lburgazzoli.github.io/posts/2023-06-13-apache-camel-pulsar-function-pt_1/><link href=/style.min.d43bc6c79baa87f006efb2b92be952faeedeb1a3ab626c1d6abda52eae049355.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://lburgazzoli.github.io/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg></head><body data-theme=dark class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://lburgazzoli.github.io/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
</a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class="menu-link active" href=/posts/>Posts</a></li><li><a class=menu-link href=/about/>About</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>Apache Camel Pulsar Function, Part 1</h1><div class=post-meta><time datetime=2023-06-15T00:00:00+00:00 itemprop=datePublished>Jun 15, 2023</time></div></header><div class=page-content><p>I recently came across an interesting <a href=https://thenewstack.io/simplified-data-pipelines-with-pulsar-transformation-functions>article from DataStax</a> about simplified, low-code friendly data piepelines with <a href=https://pulsar.apache.org/docs/functions-overview>Pulsar Function</a> and since I always wanted to learn a little bit more about <a href=https://pulsar.apache.org>Apache Pulsar</a> and I&rsquo;ve been working on something similar, I&rsquo;ve <a href=https://github.com/lburgazzoli/pulsar-function-camel>started exploring</a> how a Pulsar Function based on <a href=https://camel.apache.org>Apache Camel</a> would look like.</p><h1 id=background>Background</h1><p>To get started, let&rsquo;s have a basic understanding of Apache Pulsar and Apache Camel:</p><ul><li><a href=https://pulsar.apache.org>Apache Pulsar</a> is an open-source, distributed messaging and streaming platform built for the cloud.</li><li><a href=https://pulsar.apache.org/docs/3.0.x/functions-overview/>Apache Pulsar Functions</a> is lightweight serverless computing framework enabling developers to process and manipulate data in real-time. The framework takes care of the underlying details of sending and receiving messages. You only need to focus on the business logic</li><li><a href=https://camel.apache.org>Apache Camel</a> is an open-source integration framework that provides a wide range of connectors and patterns for integrating various systems and applications.</li></ul><h1 id=goals>Goals</h1><p>Provide a low-code, operational friendly way to deploy data transformation and routing pipelines on top of <a href=https://pulsar.apache.org>Apache Pulsar</a> leveraging <a href=https://camel.apache.org/manual/dsl.html>Apache Camel DSL</a></p><h1 id=pulsar-function-implementation>Pulsar Function Implementation</h1><p>Pulsar functions can be developed in <a href=https://pulsar.apache.org/docs/3.0.x/functions-develop-api/>Java, Python, or Go</a> and since <a href=https://camel.apache.org>Apache Camel</a> is a Java framework, we can leveraging the Java SDK to embed a Camel Routing Engine in the Function Runtime:</p><p><img src=/images/pulsar-function-camel-embedded.png alt=camel-embedded></p><p>In addition to the standard Java SDK, there is also an <a href=https://pulsar.apache.org/docs/3.0.x/functions-develop-api/#use-extended-sdk-for-java>Extended SDK for Java</a> which provides two additional interfaces to initialize and release external resources:</p><ul><li>With the <code>initialize</code> interface, you can initialize external resources which only need one-time initialization when the function instance starts.</li><li>With the <code>close</code> interface, you can close the referenced external resources when the function instance closes.</li></ul><p>In order to embed the Apache Camel in the function runtime, an instance of a <a href=https://camel.apache.org/manual/camelcontext.html>CamelContext</a>, must be created and since it is an heavyweight object, we can tie its lifecycle to the <code>initialize</code> and <code>close</code> so a CamelContext is created and started only once when the function instance starts and then it last for the entire lifecycle of the function.</p><p>At an high level, the <a href=https://github.com/lburgazzoli/pulsar-function-camel>implementation</a> does the following tasks:</p><ol><li>Initialize and start a long running CamelContext instance when the function instance starts;</li><li>Load the user defined processing steps defined using the <a href=https://camel.apache.org/components/3.20.x/others/yaml-dsl.html>Apache Camel YAML DSL</a>;</li><li>Wire the function input to the Camel&rsquo;s Route and publish back the result to Pulsar depending on the configuration and routing decision;</li><li>Close the CamelContext instance when the function instance closes.</li></ol><h1 id=pulsar-function-configuration>Pulsar Function Configuration</h1><p>The <code>CamelFunction</code> reads its configuration as <code>YAML</code> from the Function <code>userConfig</code> <code>steps</code> parameter.
As an example, a <a href=https://pulsar.apache.org/docs/3.0.x/functions-cli/>function configuration file</a> would look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>tenant</span>: <span style=color:#e6db74>&#34;public&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>namespace</span>: <span style=color:#e6db74>&#34;default&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;content-based-routing&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;persistent://public/default/input-1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>output</span>: <span style=color:#e6db74>&#34;persistent://public/default/output-1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>jar</span>: <span style=color:#e6db74>&#34;build/libs/pulsar-function-camel-${version}-all.jar&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>className</span>: <span style=color:#e6db74>&#34;com.github.lburgazzoli.pulsar.function.camel.CamelFunction&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>logTopic</span>: <span style=color:#e6db74>&#34;persistent://public/default/logging-function-logs&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>userConfig</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>steps</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - setHeader:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        name: &#34;source&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        jq: &#39;.source&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - choice:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        when:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - jq: &#39;.source == &#34;sensor-1&#34;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          steps:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - setProperty:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              name: &#39;pulsar.apache.org/function.output&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              constant: &#39;far&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - setBody:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              jq:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                expression: &#39;.data&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                resultType: &#39;java.lang.String&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - jq: &#39;.source == &#34;sensor-2&#34;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          steps:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - setProperty:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              name: &#39;pulsar.apache.org/function.output&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              constant: &#39;near&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - setBody:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              jq:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                expression: &#39;.data&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                resultType: &#39;java.lang.String&#39;</span>    
</span></span></code></pre></div><p>If you are familiar with the <a href=https://camel.apache.org/components/3.20.x/others/yaml-dsl.html>Apache Camel YAML DSL</a>, you have probably noticed that the processing pipeline does not begin with <code>from</code> or <code>route</code> as you would probably expect and this is because the Camel Pulsar Function automatically create all the boilerplate that are required to wire the Camel&rsquo;s routing engine to the Pulsar Function runtime. Beside this small difference, all the <a href=https://camel.apache.org/components/3.20.x/eips/enterprise-integration-patterns.html>Apache Camel EIPs</a> are available.</p><h1 id=access-to-contextual-data>Access to contextual data</h1><p>Some attributes of the function and record being processed are mapped to Camel&rsquo;s Exchange Properties:</p><table><thead><tr><th style=text-align:left>Pulsar</th><th style=text-align:left>Exchange Property Name</th></tr></thead><tbody><tr><td style=text-align:left>Function ID</td><td style=text-align:left>pulsar.apache.org/function.id</td></tr><tr><td style=text-align:left>Configured Output Topic</td><td style=text-align:left>pulsar.apache.org/function.output</td></tr><tr><td style=text-align:left>Record Topic</td><td style=text-align:left>pulsar.apache.org/record.topic</td></tr><tr><td style=text-align:left>Record Schema</td><td style=text-align:left>pulsar.apache.org/record.schema</td></tr><tr><td style=text-align:left>Record Key</td><td style=text-align:left>pulsar.apache.org/record.key</td></tr><tr><td style=text-align:left>Record Partition ID</td><td style=text-align:left>pulsar.apache.org/record.partition.id</td></tr><tr><td style=text-align:left>Record Partition Index</td><td style=text-align:left>pulsar.apache.org/record.partition.index</td></tr></tbody></table><h1 id=access-to-record-data>Access to Record data</h1><p>Any Function&rsquo;s Record property is mapped to an Camel&rsquo;s Message Header</p><h1 id=routing>Routing</h1><p>By default, the result of the processing pipeline is sent to the output topic defined in the function configuration, however it is possible to pick a different topic to apply a <a href=https://www.enterpriseintegrationpatterns.com/patterns/messaging/ContentBasedRouter.html>Content-Based Routing pattern</a> as show in the example, by setting the exchange property <code>pulsar.apache.org/function.output</code></p><h1 id=building-and-deploying-the-pulsar-function>Building and Deploying the Pulsar Function</h1><ol><li>Clone the repository <a href=https://github.com/lburgazzoli/pulsar-function-camel>https://github.com/lburgazzoli/pulsar-function-camel</a></li><li>Build the project by executing <code>./gradlew clean shadowJar</code></li><li>Deploy the generated function artifact (<code>build/libs/pulsar-function-camel-0.1.0-SNAPSHOT-all.jar</code>) by following the <a href=https://pulsar.apache.org/docs/3.0.x/functions-deploy/>tutorial</a></li></ol><h1 id=conclusion>Conclusion</h1><p>Event this is nothing more than a POC which requires more work to be production ready, I think that by combining Pulsar Function and Apache Camel&rsquo;s integration capabilities, developers can build robust and efficient data pipelines with ease.
The seamless integration, versatile transformation capabilities, flexible routing, and extensibility offered by this implementation make it an excellent choice for simplifying data pipelines within the Pulsar ecosystem.</p><p>To learn more about this implementation and explore its code, visit the <a href=https://github.com/lburgazzoli/pulsar-function-camel>GitHub repository</a></p><h1 id=todo>TODO</h1><ul><li><input disabled type=checkbox> Automatic data type conversion</li><li><input disabled type=checkbox> NAtive Support for Apache Pulsar in <a href=https://camel.apache.org/camel-k/1.12.x/index.html>Apache Camel K</a></li><li><input disabled type=checkbox> Experiment with <a href=https://functionmesh.io/>Pulsar Function Mesh</a></li></ul></div></article></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/lburgazzoli target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://twitter.com/lburgazzoli target=_blank rel="noopener noreferrer me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg>
</a><a href=https://www.linkedin.com/in/lucaburgazzoli target=_blank rel="noopener noreferrer me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
</a><a href=index.xml target=_blank rel="noopener noreferrer me" title=RSS><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>© 2024 .: LB :..
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel=noopener>Hugo blog awesome</a>.</small></footer><a href=# title="Go to top" id=totop><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentcolor" stroke="currentcolor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg>
</a><script src=https://lburgazzoli.github.io/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>